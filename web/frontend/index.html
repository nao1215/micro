<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MediaHub - デバッグUI</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f5f5; color: #333; }
        .header { background: #2c3e50; color: white; padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; }
        .header h1 { font-size: 1.5rem; }
        .header .user-info { font-size: 0.9rem; }
        .container { max-width: 1200px; margin: 0 auto; padding: 2rem; }
        .auth-section { text-align: center; padding: 4rem 2rem; }
        .auth-section h2 { margin-bottom: 1rem; }
        .btn { display: inline-block; padding: 0.5rem 1.5rem; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9rem; text-decoration: none; margin: 0.25rem; }
        .btn-primary { background: #3498db; color: white; }
        .btn-danger { background: #e74c3c; color: white; }
        .btn-github { background: #333; color: white; }
        .btn-google { background: #dd4b39; color: white; }
        .tabs { display: flex; gap: 0; margin-bottom: 1rem; border-bottom: 2px solid #ddd; }
        .tab { padding: 0.75rem 1.5rem; cursor: pointer; border: none; background: none; font-size: 1rem; border-bottom: 2px solid transparent; margin-bottom: -2px; }
        .tab.active { border-bottom-color: #3498db; color: #3498db; font-weight: bold; }
        .panel { display: none; }
        .panel.active { display: block; }
        .card { background: white; border-radius: 8px; padding: 1.5rem; margin-bottom: 1rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .card h3 { margin-bottom: 0.5rem; }
        .upload-area { border: 2px dashed #ccc; padding: 2rem; text-align: center; border-radius: 8px; margin-bottom: 1rem; cursor: pointer; }
        .upload-area:hover { border-color: #3498db; background: #f0f7ff; }
        .media-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem; }
        .media-item { background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .media-item img { width: 100%; height: 150px; object-fit: cover; }
        .media-item .info { padding: 0.75rem; }
        .media-item .info .name { font-weight: bold; font-size: 0.85rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .media-item .info .meta { font-size: 0.75rem; color: #888; margin-top: 0.25rem; }
        .status-badge { display: inline-block; padding: 0.15rem 0.5rem; border-radius: 12px; font-size: 0.7rem; font-weight: bold; }
        .status-uploaded { background: #fff3cd; color: #856404; }
        .status-processed { background: #d4edda; color: #155724; }
        .status-failed { background: #f8d7da; color: #721c24; }
        .saga-step { display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 0; border-bottom: 1px solid #eee; }
        .saga-step:last-child { border-bottom: none; }
        .step-icon { width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; color: white; }
        .step-completed { background: #27ae60; }
        .step-failed { background: #e74c3c; }
        .step-pending { background: #bdc3c7; }
        .step-executing { background: #f39c12; }
        .notification-item { display: flex; align-items: flex-start; gap: 0.75rem; padding: 0.75rem; border-bottom: 1px solid #eee; }
        .notification-item.unread { background: #f0f7ff; }
        .notification-dot { width: 8px; height: 8px; border-radius: 50%; background: #3498db; margin-top: 0.4rem; flex-shrink: 0; }
        .notification-dot.read { background: transparent; }
        .events-log { max-height: 400px; overflow-y: auto; font-family: monospace; font-size: 0.8rem; }
        .event-row { padding: 0.5rem; border-bottom: 1px solid #eee; }
        .event-type { font-weight: bold; color: #2c3e50; }
        .event-time { color: #888; font-size: 0.75rem; }
        #status-bar { position: fixed; bottom: 0; left: 0; right: 0; background: #2c3e50; color: #aaa; padding: 0.25rem 1rem; font-size: 0.75rem; display: flex; justify-content: space-between; }
    </style>
</head>
<body>
    <!-- 認証前画面 -->
    <div id="auth-view">
        <div class="header">
            <h1>MediaHub</h1>
        </div>
        <div class="container">
            <div class="auth-section">
                <h2>ログイン</h2>
                <p style="margin-bottom: 2rem; color: #666;">CQRS / Event Sourcing / Saga Pattern 学習用メディア管理プラットフォーム</p>
                <div>
                    <a href="/auth/github" class="btn btn-github">GitHub でログイン</a>
                    <a href="/auth/google" class="btn btn-google">Google でログイン</a>
                </div>
                <p style="margin-top: 2rem; font-size: 0.85rem; color: #999;">
                    ※ デバッグ用:
                    <button class="btn btn-primary" onclick="devLogin()">開発モードでログイン</button>
                </p>
            </div>
        </div>
    </div>

    <!-- 認証後画面 -->
    <div id="main-view" style="display: none;">
        <div class="header">
            <h1>MediaHub</h1>
            <div class="user-info">
                <span id="user-name"></span>
                <button class="btn btn-danger" onclick="logout()" style="margin-left: 0.5rem; padding: 0.25rem 0.75rem; font-size: 0.8rem;">ログアウト</button>
            </div>
        </div>
        <div class="container">
            <div class="tabs">
                <button class="tab active" onclick="switchTab('media')">メディア</button>
                <button class="tab" onclick="switchTab('albums')">アルバム</button>
                <button class="tab" onclick="switchTab('sagas')">Saga監視</button>
                <button class="tab" onclick="switchTab('events')">イベントログ</button>
                <button class="tab" onclick="switchTab('notifications')">通知</button>
            </div>

            <!-- メディアパネル -->
            <div id="panel-media" class="panel active">
                <div class="upload-area" id="upload-area" onclick="document.getElementById('file-input').click()">
                    <p>クリックまたはドラッグ＆ドロップでファイルをアップロード</p>
                    <p style="font-size: 0.8rem; color: #999; margin-top: 0.5rem;">画像・動画ファイル（最大50MB）</p>
                    <input type="file" id="file-input" style="display:none" accept="image/*,video/*" onchange="uploadFile(this.files[0])">
                </div>
                <div class="media-grid" id="media-grid">
                    <p style="color: #999; grid-column: 1/-1; text-align: center; padding: 2rem;">メディアがありません</p>
                </div>
            </div>

            <!-- アルバムパネル -->
            <div id="panel-albums" class="panel">
                <div class="card">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.5rem">
                        <h3>アルバム一覧</h3>
                        <button class="btn btn-primary" onclick="createAlbum()">+ 新規アルバム</button>
                    </div>
                    <div id="album-list">
                        <p style="color: #999; text-align: center; padding: 2rem;">アルバムがありません</p>
                    </div>
                </div>
            </div>

            <!-- Saga監視パネル -->
            <div id="panel-sagas" class="panel">
                <div class="card">
                    <h3>アクティブなSaga</h3>
                    <p style="font-size: 0.85rem; color: #666; margin-bottom: 1rem;">
                        メディアアップロードの進行状況をリアルタイムで監視できます。
                    </p>
                    <div id="saga-list">
                        <p style="color: #999; text-align: center; padding: 2rem;">アクティブなSagaはありません</p>
                    </div>
                </div>
            </div>

            <!-- イベントログパネル -->
            <div id="panel-events" class="panel">
                <div class="card">
                    <h3>イベントストア（直近のイベント）</h3>
                    <p style="font-size: 0.85rem; color: #666; margin-bottom: 1rem;">
                        Event Sourcingで記録されたすべてのイベントを閲覧できます。
                    </p>
                    <div class="events-log" id="events-log">
                        <p style="color: #999; text-align: center; padding: 2rem;">イベントがありません</p>
                    </div>
                </div>
            </div>

            <!-- 通知パネル -->
            <div id="panel-notifications" class="panel">
                <div class="card">
                    <h3>通知</h3>
                    <div id="notification-list">
                        <p style="color: #999; text-align: center; padding: 2rem;">通知がありません</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="status-bar">
        <span>MediaHub v0.1.0 - CQRS / Event Sourcing / Saga Pattern 学習プラットフォーム</span>
        <span id="connection-status">Gateway: 未接続</span>
    </div>

    <script>
        const GATEWAY = 'http://localhost:8080';
        const API_BASE = GATEWAY + '/api/v1';
        let token = localStorage.getItem('token');
        let refreshTimers = [];

        // ページ読み込み時の初期化
        document.addEventListener('DOMContentLoaded', () => {
            if (token) {
                showMainView();
            }
            checkHealth();
        });

        // 共通APIリクエスト
        async function api(path, options = {}) {
            const headers = { 'Authorization': 'Bearer ' + token, ...options.headers };
            const res = await fetch(API_BASE + path, { ...options, headers });
            return res;
        }

        // 開発モードログイン（POST /auth/dev-token）
        async function devLogin() {
            try {
                const res = await fetch(GATEWAY + '/auth/dev-token', { method: 'POST' });
                if (!res.ok) {
                    const err = await res.json();
                    alert('ログイン失敗: ' + (err.error || res.statusText));
                    return;
                }
                const data = await res.json();
                token = data.token;
                localStorage.setItem('token', token);
                showMainView();
            } catch (e) {
                alert('通信エラー: ' + e.message);
            }
        }

        function logout() {
            token = null;
            localStorage.removeItem('token');
            refreshTimers.forEach(t => clearInterval(t));
            refreshTimers = [];
            document.getElementById('auth-view').style.display = '';
            document.getElementById('main-view').style.display = 'none';
        }

        async function showMainView() {
            document.getElementById('auth-view').style.display = 'none';
            document.getElementById('main-view').style.display = '';

            // ユーザー情報取得
            try {
                const res = await api('/me');
                if (res.ok) {
                    const user = await res.json();
                    document.getElementById('user-name').textContent = user.display_name || user.email;
                } else if (res.status === 401) {
                    logout();
                    return;
                }
            } catch {
                document.getElementById('user-name').textContent = '開発ユーザー';
            }

            // 初回データ読み込み
            loadMedia();
            loadAlbums();
            loadSagas();
            loadEvents();
            loadNotifications();

            // 定期更新（5秒間隔）
            refreshTimers.push(setInterval(loadMedia, 5000));
            refreshTimers.push(setInterval(loadSagas, 3000));
            refreshTimers.push(setInterval(loadEvents, 5000));
            refreshTimers.push(setInterval(loadNotifications, 10000));
        }

        // タブ切り替え
        function switchTab(name) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('panel-' + name).classList.add('active');
        }

        // === メディア ===
        async function uploadFile(file) {
            if (!file) return;
            const formData = new FormData();
            formData.append('file', file);
            try {
                const res = await fetch(API_BASE + '/media', {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + token },
                    body: formData,
                });
                if (res.ok) {
                    alert('アップロード成功！Saga処理が開始されます。');
                    loadMedia();
                    setTimeout(loadSagas, 1000);
                } else {
                    const err = await res.json();
                    alert('アップロード失敗: ' + (err.error || res.statusText));
                }
            } catch (e) {
                alert('通信エラー: ' + e.message);
            }
        }

        async function loadMedia() {
            try {
                const res = await api('/media');
                if (!res.ok) return;
                const data = await res.json();
                renderMediaGrid(Array.isArray(data) ? data : (data.media || []));
            } catch (e) {
                console.error('メディア取得エラー:', e);
            }
        }

        async function deleteMedia(id) {
            if (!confirm('このメディアを削除しますか？')) return;
            try {
                const res = await api('/media/' + id, { method: 'DELETE' });
                if (res.ok) {
                    loadMedia();
                } else {
                    const err = await res.json();
                    alert('削除失敗: ' + (err.error || res.statusText));
                }
            } catch (e) {
                alert('通信エラー: ' + e.message);
            }
        }

        function renderMediaGrid(items) {
            const grid = document.getElementById('media-grid');
            if (!items || items.length === 0) {
                grid.innerHTML = '<p style="color: #999; grid-column: 1/-1; text-align: center; padding: 2rem;">メディアがありません</p>';
                return;
            }
            grid.innerHTML = items.map(item => `
                <div class="media-item">
                    <img src="${escapeHtml(item.thumbnail_path || '')}" alt="${escapeHtml(item.filename || '')}"
                         onerror="this.style.background='#eee';this.style.display='flex';this.alt='No thumbnail'">
                    <div class="info">
                        <div class="name">${escapeHtml(item.filename || item.id || '')}</div>
                        <div class="meta">
                            <span class="status-badge status-${item.status || 'uploaded'}">${item.status || 'uploaded'}</span>
                            ${formatFileSize(item.size || item.file_size || 0)}
                        </div>
                        <button class="btn btn-danger" style="margin-top:0.5rem;padding:0.2rem 0.5rem;font-size:0.7rem" onclick="deleteMedia('${item.id}')">削除</button>
                    </div>
                </div>
            `).join('');
        }

        function formatFileSize(bytes) {
            if (!bytes) return '';
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / 1048576).toFixed(1) + ' MB';
        }

        // === アルバム ===
        async function loadAlbums() {
            try {
                const res = await api('/albums');
                if (!res.ok) return;
                const data = await res.json();
                renderAlbums(Array.isArray(data) ? data : (data.albums || []));
            } catch (e) {
                console.error('アルバム取得エラー:', e);
            }
        }

        async function createAlbum() {
            const name = prompt('アルバム名を入力してください:');
            if (!name) return;
            try {
                const res = await api('/albums', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: name, description: '' }),
                });
                if (res.ok) {
                    loadAlbums();
                } else {
                    const err = await res.json();
                    alert('作成失敗: ' + (err.error || res.statusText));
                }
            } catch (e) {
                alert('通信エラー: ' + e.message);
            }
        }

        async function deleteAlbum(id) {
            if (!confirm('このアルバムを削除しますか？')) return;
            try {
                const res = await api('/albums/' + id, { method: 'DELETE' });
                if (res.ok) {
                    loadAlbums();
                } else {
                    const err = await res.json();
                    alert('削除失敗: ' + (err.error || res.statusText));
                }
            } catch (e) {
                alert('通信エラー: ' + e.message);
            }
        }

        function renderAlbums(albums) {
            const list = document.getElementById('album-list');
            if (!albums || albums.length === 0) {
                list.innerHTML = '<p style="color: #999; text-align: center; padding: 2rem;">アルバムがありません</p>';
                return;
            }
            list.innerHTML = '<button class="btn btn-primary" onclick="createAlbum()" style="margin-bottom:1rem">+ 新規アルバム</button>' +
                albums.map(a => `
                    <div style="display:flex;justify-content:space-between;align-items:center;padding:0.75rem;border-bottom:1px solid #eee">
                        <div>
                            <strong>${escapeHtml(a.name)}</strong>
                            <span style="color:#888;font-size:0.8rem;margin-left:0.5rem">${a.description ? escapeHtml(a.description) : ''}</span>
                            <span style="color:#aaa;font-size:0.75rem;margin-left:0.5rem">${a.media_count != null ? a.media_count + '件' : ''}</span>
                        </div>
                        <button class="btn btn-danger" style="padding:0.2rem 0.5rem;font-size:0.7rem" onclick="deleteAlbum('${a.id}')">削除</button>
                    </div>
                `).join('');
        }

        // === Saga監視 ===
        async function loadSagas() {
            try {
                const res = await api('/sagas');
                if (!res.ok) return;
                const data = await res.json();
                renderSagas(Array.isArray(data) ? data : (data.sagas || []));
            } catch (e) {
                console.error('Saga取得エラー:', e);
            }
        }

        function renderSagas(sagas) {
            const list = document.getElementById('saga-list');
            if (!sagas || sagas.length === 0) {
                list.innerHTML = '<p style="color: #999; text-align: center; padding: 2rem;">アクティブなSagaはありません</p>';
                return;
            }
            list.innerHTML = sagas.map(saga => {
                const statusClass = saga.status === 'completed' ? 'step-completed' :
                                    saga.status === 'failed' ? 'step-failed' :
                                    'step-executing';
                const statusLabel = saga.status === 'completed' ? '完了' :
                                    saga.status === 'failed' ? '失敗' :
                                    saga.status === 'compensating' ? '補償中' : '実行中';
                const steps = saga.steps || [];
                return `
                    <div class="card" style="margin-bottom:0.5rem">
                        <div style="display:flex;justify-content:space-between;align-items:center">
                            <strong>${escapeHtml(saga.saga_type || saga.type || 'Saga')}</strong>
                            <span class="status-badge" style="background:${statusClass === 'step-completed' ? '#d4edda' : statusClass === 'step-failed' ? '#f8d7da' : '#fff3cd'};color:${statusClass === 'step-completed' ? '#155724' : statusClass === 'step-failed' ? '#721c24' : '#856404'}">${statusLabel}</span>
                        </div>
                        <div style="font-size:0.8rem;color:#888;margin-top:0.25rem">
                            ステップ: ${escapeHtml(saga.current_step || '-')} | 開始: ${formatTime(saga.started_at)}
                        </div>
                        ${steps.length > 0 ? '<div style="margin-top:0.5rem">' + steps.map(step => `
                            <div class="saga-step">
                                <div class="step-icon ${step.status === 'completed' ? 'step-completed' : step.status === 'failed' ? 'step-failed' : step.status === 'executing' ? 'step-executing' : 'step-pending'}">
                                    ${step.status === 'completed' ? '&#10003;' : step.status === 'failed' ? '&#10007;' : '&#8226;'}
                                </div>
                                <span>${escapeHtml(step.step_name || step.name)}</span>
                                <span style="color:#888;font-size:0.75rem;margin-left:auto">${step.status}</span>
                            </div>
                        `).join('') + '</div>' : ''}
                    </div>
                `;
            }).join('');
        }

        // === イベントログ ===
        async function loadEvents() {
            try {
                const res = await api('/events');
                if (!res.ok) return;
                const data = await res.json();
                renderEvents(Array.isArray(data) ? data : (data.events || []));
            } catch (e) {
                console.error('イベント取得エラー:', e);
            }
        }

        function renderEvents(events) {
            const log = document.getElementById('events-log');
            if (!events || events.length === 0) {
                log.innerHTML = '<p style="color: #999; text-align: center; padding: 2rem;">イベントがありません</p>';
                return;
            }
            // 新しいイベントを上に表示
            const sorted = [...events].reverse();
            log.innerHTML = sorted.map(ev => {
                let eventData = ev.data;
                if (typeof eventData === 'string') {
                    try { eventData = JSON.parse(eventData); } catch { /* keep as string */ }
                }
                const dataStr = typeof eventData === 'object' ? JSON.stringify(eventData, null, 2) : String(eventData || '');
                return `
                    <div class="event-row">
                        <div>
                            <span class="event-type">${escapeHtml(ev.event_type)}</span>
                            <span style="color:#666;margin-left:0.5rem">[${escapeHtml(ev.aggregate_type || '')}:${escapeHtml((ev.aggregate_id || '').substring(0, 8))}...]</span>
                            <span style="color:#aaa;margin-left:0.5rem">v${ev.version || '?'}</span>
                        </div>
                        <div class="event-time">${formatTime(ev.created_at)}</div>
                        <details style="margin-top:0.25rem">
                            <summary style="cursor:pointer;color:#3498db;font-size:0.75rem">データ表示</summary>
                            <pre style="background:#f8f9fa;padding:0.5rem;border-radius:4px;margin-top:0.25rem;font-size:0.7rem;overflow-x:auto;max-height:200px">${escapeHtml(dataStr)}</pre>
                        </details>
                    </div>
                `;
            }).join('');
        }

        // === 通知 ===
        async function loadNotifications() {
            try {
                const res = await api('/notifications');
                if (!res.ok) return;
                const data = await res.json();
                renderNotifications(Array.isArray(data) ? data : (data.notifications || []));
            } catch (e) {
                console.error('通知取得エラー:', e);
            }
        }

        async function markNotificationRead(id) {
            try {
                await api('/notifications/' + id + '/read', { method: 'PUT' });
                loadNotifications();
            } catch (e) {
                console.error('既読更新エラー:', e);
            }
        }

        function renderNotifications(notifications) {
            const list = document.getElementById('notification-list');
            if (!notifications || notifications.length === 0) {
                list.innerHTML = '<p style="color: #999; text-align: center; padding: 2rem;">通知がありません</p>';
                return;
            }
            list.innerHTML = notifications.map(n => `
                <div class="notification-item ${n.is_read ? '' : 'unread'}" onclick="markNotificationRead('${n.id}')">
                    <div class="notification-dot ${n.is_read ? 'read' : ''}"></div>
                    <div style="flex:1">
                        <div style="font-weight:${n.is_read ? 'normal' : 'bold'}">${escapeHtml(n.title || n.message || '')}</div>
                        <div style="font-size:0.8rem;color:#666;margin-top:0.25rem">${escapeHtml(n.message || '')}</div>
                        <div style="font-size:0.75rem;color:#aaa;margin-top:0.25rem">${formatTime(n.created_at)}</div>
                    </div>
                </div>
            `).join('');
        }

        // === ユーティリティ ===
        function escapeHtml(str) {
            if (!str) return '';
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        function formatTime(ts) {
            if (!ts) return '';
            try {
                const d = new Date(ts);
                return d.toLocaleString('ja-JP');
            } catch {
                return ts;
            }
        }

        // ヘルスチェック
        async function checkHealth() {
            try {
                const res = await fetch(GATEWAY + '/health');
                if (res.ok) {
                    document.getElementById('connection-status').textContent = 'Gateway: 接続中';
                    document.getElementById('connection-status').style.color = '#2ecc71';
                }
            } catch {
                document.getElementById('connection-status').textContent = 'Gateway: 未接続';
                document.getElementById('connection-status').style.color = '#e74c3c';
            }
        }

        // ドラッグ＆ドロップ対応
        const uploadArea = document.getElementById('upload-area');
        if (uploadArea) {
            uploadArea.addEventListener('dragover', e => { e.preventDefault(); uploadArea.style.borderColor = '#3498db'; });
            uploadArea.addEventListener('dragleave', () => { uploadArea.style.borderColor = '#ccc'; });
            uploadArea.addEventListener('drop', e => {
                e.preventDefault();
                uploadArea.style.borderColor = '#ccc';
                if (e.dataTransfer.files.length > 0) uploadFile(e.dataTransfer.files[0]);
            });
        }

        // 定期ヘルスチェック
        setInterval(checkHealth, 10000);
    </script>
</body>
</html>
